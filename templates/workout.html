<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalorieFlow - Workouts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --cf-bg-primary: #051134;
            --cf-navbar-bg: #7ECCC4;
            --cf-card-bg: #0C1E4F;
            --cf-text-light: #f8f9fa;
            --cf-text-secondary: #adb5bd;
            --cf-link-hover: #084c48;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cf-bg-primary);
            color: var(--cf-text-light);
            min-height: 100vh;
            padding-top: 70px;
        }

        .navbar {
            background-color: var(--cf-navbar-bg);
        }

        .nav-link-item {
            color: #27403b;
            font-weight: 600;
            padding: 10px 14px;
            border-radius: 14px;
            text-decoration: none;
        }

        .nav-link-item:hover {
            color: var(--cf-link-hover);
            background: rgba(0, 0, 0, 0.05);
        }

        .nav-link-item.active {
            background: rgba(0, 0, 0, 0.12);
            color: var(--cf-link-hover);
        }

        .card {
            background: var(--cf-card-bg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg fixed-top shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold text-dark" href="{{ url_for('home') }}">CalorieFlow</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center gap-2">
                    <li class="nav-item"><a class="nav-link-item" href="{{ url_for('progress') }}">Progress</a></li>
                    <li class="nav-item"><a class="nav-link-item" href="{{ url_for('home') }}">Home</a></li>
                    <li class="nav-item"><a class="nav-link-item" href="{{ url_for('meals') }}">Meals</a></li>
                    <li class="nav-item"><a class="nav-link-item active" href="{{ url_for('workouts') }}">Workouts</a></li>
                    <li class="nav-item"><a class="nav-link-item" href="{{ url_for('settings') }}">Settings</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">Workouts</h2>
                            <p class="mb-0 text-secondary">Log sessions and review history.</p>
                        </div>
                        {% if first_name %}
                        <div class="text-end">
                            <small class="text-secondary">Signed in as</small>
                            <div class="fw-semibold">{{ first_name }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-12 col-lg-6">
                <div class="card p-4 h-100">
                    <h5 class="mb-3">Quick Log</h5>
                    <form id="workout-form" class="row gy-3">
                        <div class="col-12">
                            <label class="form-label">Activity</label>
                            <input class="form-control" name="activity_type" placeholder="e.g., Running" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Duration (min)</label>
                            <input class="form-control" type="number" min="1" name="duration" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Intensity</label>
                            <select class="form-select" name="intensity">
                                <option value="low">Low</option>
                                <option value="moderate" selected>Moderate</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Date</label>
                            <input class="form-control" type="date" name="workout_date" id="workout-date">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Time</label>
                            <input class="form-control" type="time" name="workout_time">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Calories Burned (optional)</label>
                            <input class="form-control" type="number" min="0" name="calories_burned" placeholder="Auto if left blank">
                        </div>
                        <div class="col-12 d-flex align-items-center gap-3">
                            <button class="btn btn-success px-4" type="submit">Save Workout</button>
                            <div id="workout-status" class="text-secondary small"></div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">History</h5>
                        <button class="btn btn-outline-light btn-sm" id="refresh-workouts">Refresh</button>
                    </div>
                    <div id="workout-list" class="list-group list-group-flush"></div>
                    <div id="workout-empty" class="text-secondary">No workouts yet.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const workoutsEndpoint = "{{ url_for('workouts_api') }}";
            const listEl = document.getElementById('workout-list');
            const emptyEl = document.getElementById('workout-empty');
            const formEl = document.getElementById('workout-form');
            const statusEl = document.getElementById('workout-status');
            const refreshBtn = document.getElementById('refresh-workouts');
            const dateInput = document.getElementById('workout-date');

            const today = new Date().toISOString().slice(0, 10);
            if (dateInput) dateInput.value = today;

            function setStatus(msg, isError = false) {
                statusEl.textContent = msg || '';
                statusEl.classList.toggle('text-danger', isError);
                statusEl.classList.toggle('text-secondary', !isError);
            }

            function renderWorkouts(items) {
                listEl.innerHTML = '';
                if (!items || items.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }
                emptyEl.style.display = 'none';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-group-item bg-transparent text-light border-secondary';
                    const date = item.workout_date || '';
                    const time = item.workout_time || '';
                    const calories = item.calories_burned || 0;
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">${item.activity_type}</div>
                                <div class="small text-secondary">${date} ${time}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-semibold">${item.duration} min</div>
                                <div class="small text-secondary">${calories} kcal</div>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }

            async function fetchWorkouts() {
                try {
                    const res = await fetch(`${workoutsEndpoint}?limit=20`);
                    if (!res.ok) throw new Error('Failed to load workouts');
                    const data = await res.json();
                    renderWorkouts(data);
                } catch (err) {
                    setStatus(err.message, true);
                }
            }

            formEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                setStatus('Saving...');
                const formData = new FormData(formEl);
                const payload = Object.fromEntries(formData.entries());
                try {
                    const res = await fetch(workoutsEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        const errData = await res.json().catch(() => ({}));
                        throw new Error(errData.error || 'Failed to save workout');
                    }
                    setStatus('Saved');
                    formEl.reset();
                    if (dateInput) dateInput.value = today;
                    await fetchWorkouts();
                } catch (err) {
                    setStatus(err.message, true);
                }
            });

            refreshBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setStatus('');
                fetchWorkouts();
            });

            fetchWorkouts();
        })();
    </script>
</body>

</html>
