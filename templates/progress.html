<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalorieFlow - Progress Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400;1,600;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --cf-bg-primary: #051134;
            --cf-navbar-bg: #7ECCC4;
            --cf-card-bg: #0C1E4F;
            --cf-text-light: #f8f9fa;
            --cf-text-secondary: #adb5bd;
            --cf-icon-color: #7ECCC4;
            --cf-border-color: rgba(255, 255, 255, 0.1);
            --cf-nav-bg: #7ECCC4;
            --cf-dark-contrast: #27403b;
            --cf-link-hover-blue: #0d6efd;
            --cf-link-default: #27403b;
            --cf-link-hover: #084c48;
            --cf-green-progress: #4BB543;
            --cf-water-color: #0d6efd;
            --cf-sleep-bad: #dc3545;
            --cf-weight-goal-met: #ffc107;
            --cf-protein: #0d6efd;
            --cf-carbs: #ffc107;
            --cf-fat: #dc3545;
            --cf-sugar: #8a2be2;
            --cf-fiber: #4BB543;
            --cf-meal-add-bg: #8BC4BE;
            --cf-meal-add-hover: #6e9b95;
            --cf-meal-add-color: var(--cf-bg-primary);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cf-bg-primary);
            color: var(--cf-text-light);
            min-height: 100vh;
            padding-top: 70px;
        }

        .navbar {
            background-color: var(--cf-nav-bg) !important;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 20;
        }

        .logo-text {
            font-weight: 600;
            color: var(--cf-dark-contrast);
            font-size: 1.5rem !important;
        }

        .nav-link-item {
            color: var(--cf-link-default) !important;
            font-weight: 600;
            margin: 0 1rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: color 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .nav-link-item.active {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--cf-link-hover) !important;
        }

        .nav-link-item:hover {
            color: var(--cf-link-hover) !important;
            background-color: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .nav-link-item .material-symbols-outlined {
            font-size: 20px;
            margin-right: 6px;
            font-variation-settings: 'FILL' 0, 'wght' 500;
            color: inherit;
        }

        .user-logout-combo {
            background-color: transparent;
            color: var(--cf-dark-contrast) !important;
            border: none;
            border-radius: 0.5rem;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.3s ease, color 0.3s ease;
            margin-left: 1rem;
            text-decoration: none;
        }

        .user-icon-border {
            order: 1;
            margin-left: 8px;
        }

        .user-logout-combo:hover {
            background-color: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
            color: var(--cf-link-hover-blue) !important;
        }

        .user-logout-combo:hover .user-icon-border,
        .user-logout-combo:hover .user-icon-border .material-symbols-outlined {
            color: var(--cf-link-hover-blue) !important;
            border-color: transparent !important;
        }

        .modal-content-custom {
            background-color: var(--cf-bg-primary) !important;
            border: 1px solid var(--cf-nav-bg) !important;
        }
        
        #confirmLogoutModal .modal-header {
             border-bottom: 1px solid var(--cf-border-color);
        }
        
        #confirmLogoutModal .modal-header .modal-title {
            color: var(--cf-text-light) !important;
        }
        
        #confirmLogoutModal .btn-close {
            filter: invert(1); 
        }

        .interactive-logout-btn {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 8px 16px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .interactive-logout-btn:hover {
            background-color: #c82333 !important;
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .dashboard-container {
            max-width: 1200px;
        }

        .chart-card {
            background-color: var(--cf-card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--cf-border-color);
            margin-bottom: 30px;
        }

        .chart-card h4 {
            color: var(--cf-icon-color);
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 10px;
        }

        .tooltip-box {
            visibility: hidden;
            background-color: var(--cf-bg-primary);
            color: var(--cf-text-light);
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--cf-icon-color);
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .tooltip-container:hover .tooltip-box {
            visibility: visible;
            opacity: 1;
        }

        .info-icon {
            font-size: 18px;
            color: var(--cf-text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .info-icon:hover {
            color: var(--cf-icon-color);
        }

        canvas {
            color: var(--cf-text-light) !important;
            font-family: 'Inter', sans-serif !important;
        }

        .chart-legend-container {
            margin-bottom: 20px;
            padding-top: 10px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-legend-item {
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            margin-right: 15px;
            margin-bottom: 5px;
            display: inline-flex;
            align-items: center;
            font-weight: 600;
        }

        .chart-legend-item:hover {
            transform: scale(1.03);
            opacity: 0.85;
        }
        
        .chart-legend-value {
            font-weight: 700;
            margin-left: 5px;
            color: var(--cf-text-light);
        }

        .progress-summary-box {
            background-color: var(--cf-card-bg);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--cf-border-color);
        }

        .progress-summary-box .data-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--cf-text-light);
        }

        .progress-summary-box .data-label {
            color: var(--cf-text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .btn-nav-week {
            background-color: var(--cf-card-bg);
            color: var(--cf-text-light);
            border: 1px solid var(--cf-border-color);
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .btn-nav-week:hover {
            background-color: rgba(12, 30, 79, 0.8);
            border-color: var(--cf-icon-color);
        }

        #weekRangeDisplay {
            min-width: 300px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--cf-icon-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>

    <nav id="navbar-main" class="navbar navbar-expand-lg">
        <div class="container-fluid max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center me-5" href="{{url_for('home')}}">
                <span class="fw-bold fs-5 logo-text">CalorieFlow</span>
            </a>

            <div class="d-none d-lg-flex justify-content-end ms-auto me-3">
                <a class="nav-link-item active" href="{{url_for('progress')}}">
                    <span class="material-symbols-outlined">analytics</span>
                    Progress
                </a>
                <a class="nav-link-item" href="{{url_for('home')}}">
                    <span class="material-symbols-outlined">home</span>
                    Home
                </a>
                <a class="nav-link-item" href="{{url_for('meals')}}">
                    <span class="material-symbols-outlined">restaurant</span>
                    Meals
                </a>
                <a class="nav-link-item" href="workout_page.html">
                    <span class="material-symbols-outlined">fitness_center</span>
                    Workouts
                </a>
                <a class="nav-link-item" href="{{url_for('settings')}}">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </a>
            </div>

            <div>
                <button class="user-logout-combo" id="logoutDirectBtn" data-bs-toggle="modal"
                    data-bs-target="#confirmLogoutModal" aria-label="Log Out">
                    <span>Log Out</span>
                    <span class="user-icon-border">
                        <span class="material-symbols-outlined">logout</span>
                    </span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container my-5 dashboard-container">
        <h1 class="text-white fw-bold mb-4">Weekly Progress & Analytics</h1>

        <div class="d-flex justify-content-center align-items-center mb-5">
            <button class="btn btn-nav-week" id="prevWeekBtn">
                <span class="material-symbols-outlined">arrow_back_ios_new</span> Previous Week
            </button>

            <h3 class="text-white fw-bold mb-0 mx-4 text-center" id="weekRangeDisplay">
                <span class="loading-spinner"></span> Loading Week...
            </h3>

            <button class="btn btn-nav-week" id="nextWeekBtn">
                Next Week <span class="material-symbols-outlined">arrow_forward_ios</span>
            </button>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-4 col-md-6">
                <div class="progress-summary-box">
                    <span class="material-symbols-outlined" style="color: var(--cf-water-color); font-size: 28px;">water_drop</span>
                    <div class="data-value" id="totalWater">--</div>
                    <div class="data-label">Total Water Intake (L)</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="progress-summary-box">
                    <span class="material-symbols-outlined" style="color: var(--cf-icon-color); font-size: 28px;">dark_mode</span>
                    <div class="data-value" id="avgSleep">--</div>
                    <div class="data-label">Avg. Sleep Per Night (hrs)</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="progress-summary-box">
                    <span class="material-symbols-outlined" style="color: var(--cf-green-progress); font-size: 28px;">monitor_weight</span>
                    <div class="data-value" id="currentWeight">--</div>
                    <div class="data-label">Current Weight (kg)</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="chart-card">
                    <h4>
                        Daily Calorie Balance (Consumed vs. Burned vs. Net)
                        <div class="tooltip-container">
                            <span class="material-symbols-outlined info-icon">info</span>
                            <div class="tooltip-box">
                                <strong>Net Calories are Key!</strong>
                                <p class="mb-1 mt-2">This chart shows your net calorie balance each day (Consumed - Burned). The green bar represents the final net surplus or deficit.</p>
                                <p class="mb-1">**Tip:** Click on a legend item (e.g., "Consumed") to toggle that data series on or off and focus on specific metrics.</p>
                                <p class="mb-0">Color Key: <span style="color: var(--cf-water-color);">Consumed</span> | <span style="color: var(--cf-sleep-bad);">Burned</span> | <span style="color: var(--cf-green-progress);">Net</span></p>
                            </div>
                        </div>
                    </h4>
                    <div class="chart-legend-container"></div>
                    <canvas id="calorieBalanceChart"></canvas>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-card">
                    <h4>
                        Weight Trend (Last 7 Days)
                        <div class="tooltip-container">
                            <span class="material-symbols-outlined info-icon">info</span>
                            <div class="tooltip-box">
                                <strong>Tracking Consistency</strong>
                                <p class="mb-1 mt-2">This chart tracks your weight over the last week. The trend line (Green) indicates your progress toward your long-term goal.</p>
                                <p class="mb-0">**Tip:** Track your weight at the same time each day for the most accurate trend visualization.</p>
                            </div>
                        </div>
                    </h4>
                    <canvas id="weightTrendChart"></canvas>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="chart-card">
                    <h4>
                        Water and Sleep Consistency
                        <div class="tooltip-container">
                            <span class="material-symbols-outlined info-icon">info</span>
                            <div class="tooltip-box">
                                <strong>Hydration & Recovery</strong>
                                <p class="mb-1 mt-2">This dual-axis chart compares your daily water intake (Teal, left axis) against your hours of sleep (Yellow, right axis).</p>
                                <p class="mb-0">**Tip:** Click the legend items to view only water or only sleep totals.</p>
                            </div>
                        </div>
                    </h4>
                    <div class="chart-legend-container" id="consistencyLegendContainer"></div>
                    <canvas id="consistencyChart"></canvas>
                </div>
            </div>

            <div class="col-lg-12">
                <div class="chart-card">
                    <h4>
                        Total Weekly Macro Intake (Grams)
                        <div class="tooltip-container">
                            <span class="material-symbols-outlined info-icon">info</span>
                            <div class="tooltip-box">
                                <strong>Absolute Macro Totals</strong>
                                <p class="mb-1 mt-2">This chart shows the total grams consumed for Protein, Carbs, Fat, Sugar, and Fiber across the selected 7-day period.</p>
                                <p class="mb-0">**Tip:** While this is visually a ratio, the labels represent the absolute total grams tracked, not a percentage split.</p>
                            </div>
                        </div>
                    </h4>
                    <div class="chart-legend-container" id="macroLegendContainer"></div>
                    <div style="max-width: 500px; margin: 0 auto;">
                        <canvas id="macroSplitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmLogoutModal" tabindex="-1" aria-labelledby="confirmLogoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-content-custom">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmLogoutModalLabel" style="color: var(--cf-text-light);">Confirm Log Out</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body text-secondary">
                    Are you sure you want to log out of CalorieFlow? You can always sign back in.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{{url_for('logout')}}">
                        <button type="button" class="btn interactive-logout-btn">Yes, Log Out</button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        Chart.defaults.color = 'var(--cf-text-secondary)';
        Chart.defaults.font.family = 'Inter, sans-serif';

        const colorCodedLegendPlugin = {
            id: 'colorCodedLegend',
            afterUpdate: (chart) => {
                let legendDiv;
                if (chart.canvas.id === 'calorieBalanceChart') {
                    legendDiv = chart.canvas.parentNode.querySelector('.chart-legend-container');
                } else if (chart.canvas.id === 'consistencyChart') {
                    legendDiv = document.getElementById('consistencyLegendContainer');
                } else if (chart.canvas.id === 'macroSplitChart') {
                    legendDiv = document.getElementById('macroLegendContainer');
                }

                if (legendDiv && chart.options.plugins.legend.colorCode === true) {
                    legendDiv.innerHTML = '';
                    const items = chart.options.plugins.legend.labels.generateLabels(chart);
                    const macroData = chart.canvas.id === 'macroSplitChart' ? chart.data.datasets[0].data : null;

                    items.forEach((item, index) => {
                        const color = item.fillStyle || item.strokeStyle || 'white';
                        const isHidden = item.hidden;

                        const legendItem = document.createElement('div');
                        legendItem.className = `chart-legend-item`;
                        legendItem.style.opacity = isHidden ? '0.4' : '1';
                        legendItem.style.pointerEvents = 'auto';

                        legendItem.onclick = () => {
                            if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                                chart.toggleDataVisibility(item.index);
                            } else {
                                chart.setDatasetVisibility(item.datasetIndex, !chart.isDatasetVisible(item.datasetIndex));
                            }
                            chart.update();
                        };

                        const colorSquare = document.createElement('span');
                        colorSquare.style.backgroundColor = color;
                        colorSquare.style.width = '12px';
                        colorSquare.style.height = '12px';
                        colorSquare.style.borderRadius = chart.config.type === 'doughnut' ? '50%' : '3px';
                        colorSquare.style.marginRight = '8px';

                        const text = document.createElement('span');
                        text.style.color = color;
                        
                        if (chart.canvas.id === 'macroSplitChart' && macroData) {
                            const macroName = item.text.replace(/\s\(g\)/, '');
                            const macroValue = macroData[item.index];
                            text.innerHTML = `${macroName}: <span class="chart-legend-value">${macroValue}g</span>`;
                        } else {
                            text.textContent = item.text;
                        }

                        legendItem.appendChild(colorSquare);
                        legendItem.appendChild(text);
                        legendDiv.appendChild(legendItem);
                    });
                }
            }
        };

        let currentWeekStartDate = new Date();

        const formatDateLabel = (date) => {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        const getWeekRangeString = (startDate) => {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            const startLabel = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const endLabel = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            return `${startLabel} - ${endLabel}`;
        };

        const formatDateForAPI = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const fetchWeeklyData = async (startDate) => {
            try {
                const dateStr = formatDateForAPI(startDate);
                const response = await fetch(`/api/progress/weekly?week_start=${dateStr}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                return {
                    labels: data.labels,
                    consumed: data.consumed,
                    burned: data.burned,
                    net: data.net,
                    weight: data.weight,
                    water: data.water,
                    sleep: data.sleep,
                    macroTotals: {
                        protein: data.macros.protein,
                        carbs: data.macros.carbs,
                        fat: data.macros.fat,
                        sugar: data.macros.sugar,
                        fiber: data.macros.fiber
                    },
                    summary: data.summary
                };
            } catch (error) {
                console.error('Error fetching weekly data:', error);
                alert('Failed to load progress data. Please refresh the page.');
                
                return {
                    labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    consumed: [0, 0, 0, 0, 0, 0, 0],
                    burned: [0, 0, 0, 0, 0, 0, 0],
                    net: [0, 0, 0, 0, 0, 0, 0],
                    weight: [null, null, null, null, null, null, null],
                    water: [0, 0, 0, 0, 0, 0, 0],
                    sleep: [0, 0, 0, 0, 0, 0, 0],
                    macroTotals: { protein: 0, carbs: 0, fat: 0, sugar: 0, fiber: 0 },
                    summary: { total_water_l: 0, avg_sleep: 0, current_weight: 0 }
                };
            }
        };

        const loadWeek = async (offsetDays) => {
            const newStartDate = new Date(currentWeekStartDate);
            newStartDate.setDate(currentWeekStartDate.getDate() + offsetDays);
            currentWeekStartDate = newStartDate;

            document.getElementById('weekRangeDisplay').innerHTML = '<span class="loading-spinner"></span> Loading...';

            const weekData = await fetchWeeklyData(currentWeekStartDate);

            updateCharts(weekData);
            updateSummaryBoxes(weekData.summary);

            document.getElementById('weekRangeDisplay').textContent = getWeekRangeString(currentWeekStartDate);
        };

        const updateSummaryBoxes = (summary) => {
            document.getElementById('totalWater').textContent = summary.total_water_l.toFixed(2) + ' L';
            document.getElementById('avgSleep').textContent = summary.avg_sleep.toFixed(1) + ' hrs';
            document.getElementById('currentWeight').textContent = summary.current_weight.toFixed(1) + ' kg';
        };

        let calorieBalanceChart, weightTrendChart, consistencyChart, macroSplitChart;

        const updateCharts = (data) => {
            const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

            const colorConsumed = getCssVar('--cf-water-color');
            const colorBurned = getCssVar('--cf-sleep-bad');
            const colorNet = getCssVar('--cf-green-progress');
            const colorWeight = getCssVar('--cf-green-progress');
            const colorWater = getCssVar('--cf-icon-color');
            const colorSleep = getCssVar('--cf-weight-goal-met');
            const colorGrid = getCssVar('--cf-border-color');
            const colorTicks = getCssVar('--cf-text-light');
            const colorProtein = getCssVar('--cf-protein');
            const colorCarbs = getCssVar('--cf-carbs');
            const colorFat = getCssVar('--cf-fat');
            const colorSugar = getCssVar('--cf-sugar');
            const colorFiber = getCssVar('--cf-fiber');

            const chartConfig = [
                {
                    id: 'calorieBalanceChart', type: 'bar', chart: calorieBalanceChart,
                    data: {
                        labels: data.labels,
                        datasets: [
                            { label: 'Consumed (kcal)', data: data.consumed, backgroundColor: colorConsumed, borderRadius: 4 },
                            { label: 'Burned (kcal)', data: data.burned, backgroundColor: colorBurned, borderRadius: 4 },
                            { label: 'Net (Consumed - Burned)', data: data.net, backgroundColor: colorNet, borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { grid: { display: false }, ticks: { color: colorTicks } },
                            y: { beginAtZero: true, grid: { color: colorGrid }, ticks: { color: colorTicks } }
                        },
                        plugins: { legend: { display: false, colorCode: true } },
                        layout: { padding: { top: 10 } }
                    }
                },
                {
                    id: 'weightTrendChart', type: 'line', chart: weightTrendChart,
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Weight (kg)', data: data.weight, borderColor: colorWeight,
                            backgroundColor: 'rgba(75, 181, 67, 0.2)', borderWidth: 3, tension: 0.4, 
                            pointRadius: 6, pointBackgroundColor: colorWeight,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { grid: { color: colorGrid }, ticks: { color: colorTicks } },
                            x: { grid: { display: false }, ticks: { color: colorTicks } }
                        },
                        plugins: { legend: { display: false } }
                    }
                },
                {
                    id: 'consistencyChart', type: 'bar', chart: consistencyChart,
                    data: {
                        labels: data.labels,
                        datasets: [
                            { label: 'Water (ml)', data: data.water, backgroundColor: colorWater, yAxisID: 'y1', borderRadius: 4 },
                            { label: 'Sleep (hours)', data: data.sleep, backgroundColor: colorSleep, yAxisID: 'y2', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { grid: { display: false }, ticks: { color: colorTicks } },
                            y1: {
                                type: 'linear', position: 'left', beginAtZero: true, max: 3000,
                                title: { display: true, text: 'Water (ml)', color: colorWater },
                                grid: { color: colorGrid }, ticks: { color: colorTicks }
                            },
                            y2: {
                                type: 'linear', position: 'right', beginAtZero: true, max: 12,
                                title: { display: true, text: 'Sleep (hours)', color: colorSleep },
                                grid: { display: false }, ticks: { color: colorTicks }
                            }
                        },
                        plugins: { legend: { display: false, colorCode: true } },
                        layout: { padding: { top: 10 } }
                    }
                },
                {
                    id: 'macroSplitChart', type: 'doughnut', chart: macroSplitChart,
                    data: {
                        labels: ['Protein (g)', 'Carbohydrates (g)', 'Fat (g)', 'Sugar (g)', 'Fiber (g)'],
                        datasets: [{
                            label: 'Macro Totals (g)',
                            data: [
                                data.macroTotals.protein,
                                data.macroTotals.carbs,
                                data.macroTotals.fat,
                                data.macroTotals.sugar,
                                data.macroTotals.fiber
                            ],
                            backgroundColor: [colorProtein, colorCarbs, colorFat, colorSugar, colorFiber],
                            hoverOffset: 10, borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false, colorCode: true },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label = label.replace(/\s\(g\)/, '');
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.formattedValue + 'g';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                }
            ];

            chartConfig.forEach(config => {
                if (!config.chart) {
                    config.chart = new Chart(document.getElementById(config.id), {
                        type: config.type,
                        data: config.data,
                        options: { responsive: true, ...config.options },
                        plugins: (config.id === 'calorieBalanceChart' || config.id === 'consistencyChart' || config.id === 'macroSplitChart') ? [colorCodedLegendPlugin] : []
                    });
                    if (config.id === 'calorieBalanceChart') calorieBalanceChart = config.chart;
                    if (config.id === 'weightTrendChart') weightTrendChart = config.chart;
                    if (config.id === 'consistencyChart') consistencyChart = config.chart;
                    if (config.id === 'macroSplitChart') macroSplitChart = config.chart;
                } else {
                    config.chart.data.datasets = config.data.datasets;
                    config.chart.data.labels = config.data.labels;
                    
                    if (config.id === 'macroSplitChart') {
                        config.chart.data.datasets[0].data = [
                            data.macroTotals.protein,
                            data.macroTotals.carbs,
                            data.macroTotals.fat,
                            data.macroTotals.sugar,
                            data.macroTotals.fiber
                        ];
                    }
                    config.chart.update();
                }
            });
        };

        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            let startOfCurrentWeek = new Date(today);
            startOfCurrentWeek.setDate(startOfCurrentWeek.getDate() - startOfCurrentWeek.getDay());
            currentWeekStartDate = startOfCurrentWeek;

            loadWeek(0);

            document.getElementById('prevWeekBtn').addEventListener('click', () => loadWeek(-7));
            document.getElementById('nextWeekBtn').addEventListener('click', () => loadWeek(7));
        });
    </script>
</body>
</html>